<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Оформление заказа</title>
    <link rel="stylesheet" href="css/order-page-style.css">
    <link href="https://fonts.googleapis.com/css?family=Oxygen|Raleway&display=swap" rel="stylesheetFont">
    <link rel="stylesheet" href="loading-bar/loading-bar.css">
    <script src="loading-bar/loading-bar.js"></script>
</head>
<body>

<header class="header">
    <div class="shop-name">
        ESDP Java-1,2 Project
    </div>
    <div class="title-text">
        Страница для оформления заказа
    </div>
</header>


<div class="form">

    <form action="/" id="order-form">
        <input type="hidden" name="shopName" value="Example Shop">
        <div>
            <div> ФИО</div>
            <input name="userName" value="test" type="text" required>
        </div>
        <div>
            <div> Адрес электронной почты</div>
            <input name="email"  value="test@test.com" type="email" required>
        </div>
        <div>
            <div> Контактный телефон</div>
            <input name="phone" type="tel" minlength="5"  value="7-777-777-77-77" placeholder="7-777-777-77-77" maxlength="24"
                   pattern="[[0-9]{1}-[0-9]{3}-[0-9]{3}-[0-9]{2}-[0-9]{2}" required>
        </div>
        <div>
            <div> Номер заказа </div>
            <input name="order_id" value="1000" type="number" required>
        </div>
        <div>
            <div> Сумма</div>
            <input name="amount" value="10000" type="number" required>
        </div>

        <button id="order-button" class="button-submit" type="submit">
            Оформить заказ
        </button>
    </form>

</div>
<script>
    let orderButton = document.getElementById("order-button");
    let orderForm = document.getElementById("order-form");
    let errorTrigger = null;

    //1. Нажимаем на кнопку "Оформить заказ"
    orderButton.addEventListener("click", function (e) {
        e.preventDefault();
        //Получаем данные с формы заказа покупателя для отправки на сервер и вывода в модальном окне
        let orderData = new FormData(orderForm);
        let infoOrder = Object.fromEntries(orderData);
        //Разметка модальной формы оплаты
        let purchaseHtml = `<section class="right">
            <div class = "purchase-container">
            <h1>Страница оплаты</h1>
            <div class="data">
            <div class="order-text"> <p> Магазин: ${infoOrder.shopName} </p></div>
            <div class="order-text"> <p> Покупатель: ${infoOrder.userName}</p></div>
            <div class="order-text"> <p> Email: ${infoOrder.email}</p></div>
            <div class="order-text"> <p> Телефон: ${infoOrder.phone}</p></div>
            <div class="order-text"> <p> Заказ: ${infoOrder.order_id}</p></div>
            <div class="order-text"> <p> Сумма : ${infoOrder.amount}</p></div>
            </div>
            <form action="#" id="purchase-form">
                    <input type="hidden" name="shopName" value=${infoOrder.shopName}>
                     <input type="hidden" name="userName" value=${infoOrder.userName}>
                     <input type="hidden" name="email" value=${infoOrder.email}>
                    <input type="hidden" name="phone" value=${infoOrder.phone}>
                     <input type="hidden" name="amount" value=${infoOrder.amount}>
                <div class="form-name form-field">
                    <label for="cc-number">Имя держателя карты</label>
                    <input name="cardHolderName" class="cc-name" type="text" placeholder="John John" required>
                </div>
                <div class="form-card form-field">
                    <label for="cc-number">Номер карты</label>
                    <input name="CARD" class="cc-number" value="1111111111111111" type="text" placeholder="1111 2222 3333 4444"
                           required minlength="15"
                           maxlength="16" size="16">
                </div>

                <div class="form-date form-field">
                    <label for="expiry-month">Срок действия</label>
                    <div class="date-val">
                        <select name="EXP" class="expiry-month" required>
                            <option class="trans-label_month" value="" default="default" selected="selected">Месяц</option>
                            <option value="1">01</option>
                            <option value="2">02</option>
                            <option value="3">03</option>
                            <option value="4">04</option>
                            <option value="5">05</option>
                            <option value="6">06</option>
                            <option value="7">07</option>
                            <option value="8">08</option>
                            <option value="9">09</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                        <select name="EXP_YEAR" class="expiry-year" required>
                            <option class="trans-label_year" value="" default="" selected="selected">Год</option>
                            <option value="2020">20</option>
                            <option value="2021">21</option>
                            <option value="2022">22</option>
                            <option value="2023">23</option>
                            <option value="2024">24</option>
                            <option value="2025">25</option>
                            <option value="2026">26</option>
                            <option value="2027">27</option>
                            <option value="2028">28</option>
                            <option value="2029">29</option>
                            <option value="2030">30</option>
                            <option value="2031">31</option>
                            <option value="2032">32</option>
                            <option value="2033">33</option>
                            <option value="2034">34</option>
                            <option value="2035">35</option>
                            <option value="2036">36</option>
                            <option value="2037">37</option>
                            <option value="2038">38</option>
                            <option value="2039">39</option>
                            <option value="2040">40</option>
                            <option value="2041">41</option>
                            <option value="2042">42</option>
                            <option value="2043">43</option>
                            <option value="2044">44</option>
                            <option value="2045">45</option>
                            <option value="2046">46</option>
                            <option value="2047">47</option>
                        </select>
                    </div>
                </div>

                <div class="form-sec-code form-field">
                    <label for="sec-code">CVC код</label>
                    <input name="CVC2" type="password" inputmode="numeric" minlength="2" maxlength="3" size="3"
                           placeholder="123" required>
                </div>
                <button type="submit" id="purchase-button"> Оплатить </button>

            </form>
            </div>
        </section>`;

        //Создаем элемент и вкладываем в него нашу разметку и добавляем в DOM
        let html = document.createElement("div");
        html.setAttribute("class", "purchase-block");
        html.innerHTML = purchaseHtml.trim();
        let placeForPurchase = document.getElementsByTagName("body")[0].children[1];
        placeForPurchase.prepend(html);

        //Убираем лишние обьекты формы заказа
        orderForm.hidden = true;

        //Вешаем слушателя на кнопку оплаты в форме оплаты
        let purchaseForm = document.getElementById("purchase-form");
        let url = "http://localhost:8080/pay";
        //2. Нажимаем на кпоку "Оплатить"
        purchaseForm.addEventListener("submit", async function (e) {
            e.preventDefault();

            //Отправляем форму оплаты с информацией о карте и покупателе
            let formData = new FormData(purchaseForm);
            let transaction = Object.fromEntries(formData);
            console.log(transaction);
            let response = await fetch(url, {
                method: "post",
                headers: {"Content-Type": "application/json;charset=utf-8"},
                body: JSON.stringify(transaction)
            });

            //Если ответ от сервера не 200 то мы обрабатываем ошибку и выводим ее на модальное окно
            if(response.status !== 200){
                let errors = await response.json();
                let result = JSON.stringify(errors);

                //Создаем разметку ошибки с классом "error"
                let errorHtml = document.createElement("div");
                errorHtml.setAttribute("class", "error");
                //Форматируем ответ ошибки
                let parError = `<p style="color:red">${result.toString().substr(2, (result.length - 4))}</p>`;
                errorHtml.innerHTML = parError.trim();

                //Создали триггер для проверки на повторную ошибку
                //Если триггер не равен нынешней ошибке
                if (errorTrigger !== errors){
                    //И если он не пустой
                    if (errorTrigger !== null) {
                        //То значит там уже есть ошибка и мы удаляем старую ошибку
                        let element = document.getElementsByClassName("error")[0];
                        element.parentNode.removeChild(element);
                    }
                    //Если триггер пустой, значит ошибки ранее не было и мы без проверки вставляем ошибку
                    document.getElementsByClassName("form-sec-code")[0].prepend(errorHtml);
                    errorTrigger = errors;
                }
            }else{
                //Восстановление страницы заказа покупателя
            let progressBarHtml = document.createElement("div");
                progressBarHtml.setAttribute("class", "lv-circles lg lv-mid");
                progressBarHtml.setAttribute("id", "progressBar");
                document.getElementsByClassName("purchase-container")[0].hidden = true;
                document.getElementsByClassName("right")[0].append(progressBarHtml);

                //Создаем переменную загрузочной иконки
                //Инициализируем иконку загрузки
                let element = lv.create(document.getElementById("progressBar"));
                // orderForm.hidden = false;
                // document.getElementsByClassName("purchase-block")[0].hidden = true;
            }
            // window.location.href = "http://localhost:8080/";
        });

    });

</script>
</body>
</html>